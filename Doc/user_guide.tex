\documentclass[12pt,a4paper]{article}
\def\version{0.2.0}
\def\qe{{\sc Quantum ESPRESSO}}

\usepackage{html}

\usepackage{graphicx}

\textwidth = 17cm
\textheight = 24cm
\topmargin =-1 cm
\oddsidemargin = 0 cm

\def\pwx{\texttt{pw.x}}
\def\phx{\texttt{ph.x}}
\def\configure{\texttt{configure}}
\def\PWscf{\texttt{PWscf}}
\def\PHonon{\texttt{PHonon}}
\def\thermo{\texttt{thermo\_pw}}
\def\make{\texttt{make}}

\begin{document} 
\author{}
\date{}

\def\qeImage{../../Doc/quantum_espresso.pdf}
\def\democritosImage{../../Doc/democritos.pdf}
\def\SissaImage{./sissa.pdf}

\title{
%  \includegraphics[width=6cm]{\SissaImage}\\
  \vskip 1cm
  \Huge User's Guide for the \thermo\ package \smallskip
  \Large (version \version)
}

\maketitle

\tableofcontents

\section{Introduction}

This guide covers the usage and installation of the \thermo\ package. 
It assumes that you know the contents of the general User's Guide for \qe\ 
and of the User's Guide for \PWscf\ and for \PHonon. 
If not, please locate the general User's Guide in directory 
\texttt{Doc/} of your \qe\ distribution,
the User's Guide for \PWscf\ in \texttt{PW/Doc/} and the User's Guide
for \PHonon\ in \texttt{PHonon/Doc/}, or consult the web site:
\texttt{http://www.quantum-espresso.org}.

\thermo\ is a set of drivers to compute material properties. 
The same calculations can be done by using the \qe\ package, but they would 
require several steps. These tasks are usually carried out by \texttt{bash}
scripts. \thermo\ allows to avoid the writing of complex \texttt{bash}
scripts for the most common material properties. It can be considered as a set 
of scripts written in \texttt{FORTRAN}. At low level \thermo\ uses the \qe\ 
routines and writes the same files. If needed, these files could be read
by the codes of the \qe\ package. 

\thermo\ has the following directory structure, contained in a subdirectory 
\texttt{thermo\_pw/} that should be put in the main directory of the \qe\ tree:

\begin{tabular}{ll}
\texttt{Doc/}      & : contains this user\_guide \\
\texttt{examples/} & : some running examples \\
\texttt{inputs/}   & : a collection of useful inputs \\
\texttt{lib/}      & : source files for modules used by \thermo\ \\
\texttt{src/}      & : source files for \thermo\ \\
\texttt{tools/}    & : source files for auxiliary tools \\
\end{tabular}\\

The \thermo\ package can perform the following types of calculations:
\begin{itemize}
\item Plot of the Brillouin zone (the structure can be seen by reading the
input of \thermo\ by the \texttt{XCrySDen} program).

\item Computation of the total energy.

\item Total energy as a function of the kinetic energy cut-off.

\item Total energy as a function of {\bf k}-points and smearing.

\item Band structure calculation at fixed geometry.

\item Phonon frequencies at fixed geometry.

\item Phonon dispersions at fixed geometry and computation of the harmonic
thermodynamical properties: vibrational energy, vibrational free energy,
vibrational entropy, and constant volume molar heat capacity as a function
of temperature.

\item Murnaghan fit of the total energy as function of the lattice parameter.

\item Band structure at the Murnaghan minimum.

\item Phonon frequencies at the Murnaghan minimum.

\item Phonon dispersions and harmonic vibrational thermodynamic quantities
at the Murnaghan minimum.

\item Phonon dispersions at several geometries and calculation of the
anharmonic vibrational properties: lattice parameter, bulk modulus,
pressure derivative of the bulk modulus as a function of temperature.
Gruneisen parameters. Thermal expansion as a function of temperature.
Isobaric molar heat capacity as a function of temperature.
Isoentropic bulk modulus as a function of temperature.
Average Gruneisen parameter as a function of temperature.

\item Frozen ions and total elastic constants.

\item Frozen ions and total piezoelectric tensor.

\item Surface band structure identification and plot of the projected bulk
band structure.
\end{itemize}

\thermo\ can run in parallel using all the parallel modes available in
the \qe\ package. On top of that \thermo\ can be run using several images.
The image parallelization is used when possible in an asynchronous way.
One processor takes the role of master and distributes the work 
to all the images that carry it out independently. Presently 
the total energies of several geometries for a Murnaghan fit are
calculated independently, and in parallel if there are several images.  
The phonon calculation is carried out in parallel, each image doing 
a single representation.

\section{People}
The \thermo\ code has been developed and is maintained by Andrea Dal Corso 
(SISSA). It is mainly an experimental tool to test new ideas for \qe\ 
organization. It is an open source code distributed, as it is, within the GPL 
licence.  

\section{Installing, Compiling, and Running}

\subsection{Installing}

\thermo\ is a package tightly bound to \qe. It cannot be compiled without
the \qe\ routines. For instruction on how to download and compile \qe, please 
refer to the general User's Guide, available in file \texttt{Doc/user\_guide.pdf}
under the main \qe\ directory, or in web site \\
\texttt{http://www.quantum-espresso.org}.

Once \qe\ is correctly configured, you need to download the \PHonon\ 
package. This can be done automatically just typing \texttt{make ph}, from 
the main \qe\ directory.

\texttt{Thermo\_pw.0.1.0.tar.gz} can be downloaded from the 
\texttt{qe-forge} website at \texttt{http://www.qe-} \texttt{forge.org/gf/project/thermo\_pw/frs/}. This version is compatible with \qe\ 5.1.1
but there is no version of \texttt{thermo\_pw} compatible with previous
versions.
The CVS version of the \texttt{thermo\_pw} directory can be downloaded as 
described at
the web page: \texttt{http://www.qe-} \texttt{forge.org/gf/project/thermo\_pw/scmcvs/?action=AccessInfo}.
The CVS version of \texttt{thermo\_pw} works only with the SVN version of \qe. 

\subsection{Compiling}

In order to compile \thermo\ the main \texttt{Makefile} and a few other
files of \qe\ need to be updated. Just enter in the \texttt{thermo\_pw}
directory and give the command \texttt{make join\_qe}. This command exchanges
the files contained in \texttt{thermo\_pw} with those of the \qe\ package.
Typing \texttt{make thermo\_pw} from the root \qe\ directory, or \texttt{make} 
from the \texttt{thermo\_pw}\ directory, produces the executable
\texttt{thermo\_pw/src/thermo\_pw.x} that is linked in the 
\qe\ \texttt{bin/} directory. Note that you need to compile \texttt{pw.x},
\texttt{ph.x}, and \texttt{pp.x} before \texttt{thermo\_pw}.
\thermo\ has been written on a PC with Linux operating system using the
\texttt{gfortran} compiler with \texttt{openMPI} parallelization. Any other
combination of computer/operating system has not been tested, but usually
\thermo\ runs on the same systems where \qe\ runs.

\subsection{Uninstalling}

In order to remove \thermo\ from your \qe\ distribution, just enter in the
\texttt{thermo\_pw} directory and give the command \texttt{make leave\_qe}.
Then just remove the \texttt{thermo\_pw} directory. Please be careful, the
command \texttt{make leave\_qe} can be given only if you have already
given the command \texttt{make join\_qe} otherwise it might scramble the
\texttt{Makefiles} of \texttt{QE}.

\subsection{Running \thermo}

In order to use the \thermo\ code you need to create a file called
\texttt{thermo\_control} in your working directory in addition to copy
there the input of \texttt{pw.x} and, if requested by the task, an
input of \texttt{ph.x} that must be called \texttt{ph\_control}.
The input of \texttt{pw.x} can have any name and is given as input to
the \thermo\ code. It is not necessary to specify an \texttt{outdir} 
directory in the \texttt{ph.x} input.

A typical command for running the \thermo\ code could be:
\begin{verbatim}
mpirun -n np thermo_pw.x -ni ni ... < input_pw > output_thermo_pw
\end{verbatim}
where \texttt{np} is the number of processors and \texttt{ni} is the number 
of images. The dots indicate the other parallelization options that
you can find in the \qe\ manual.

Note that it is very easy to waste a lot of resources if the number of 
images is too large. Some options do not use the image feature, so you have
to know how the calculation is divided and the number of images must not
be larger than the number of tasks (see below an indication of this number
for each option).

One or more \texttt{postscript} files with plots of the material properties
are the output of the \thermo\ code. It produces also files with the data of 
the plot and scripts for the \texttt{gnuplot} program. 
Normally, the user does not need to modify these files, but they allow 
the improvement of the figures if needed.
The plot of the Brillouin zone (BZ) is done with the help of the 
\texttt{asymptote} code. \texttt{Thermo\_pw} produces a script of commands
for the \texttt{asymptote} code and can also run it to produce the pdf
file of the BZ.

The \thermo\ code has a minimal recovery feature. It does not recalculate
the quantities contained in files that are already in the working
directory. Each routine checks if a file with the same name
as the file that it would produce is already in the working directory,
and if this happens, it returns. Note that this feature cannot be 
disabled from input. In order to recalculate a given quantity, just remove
the file that contains it in the working directory.
The \thermo\ code cannot recover automatically a partial phonon calculation, all 
the dynamical matrices of a given geometry must be in the working directory to 
skip the calculation. If one is missing all the phonon calculations are repeated. 
In that case you might want to use the recover feature  of the \texttt{ph.x} code 
by specifying \texttt{recover=.true.} in the input of this code.

\section{Input variables}

The \texttt{pw.x} and \texttt{ph.x} input files are described in the documentation
mentioned above. In this section we discuss only the creation of the file
\texttt{thermo\_control}. This file contains a namelist:  
\begin{verbatim}
&INPUT_THERMO
  what=' ',
  ...
 /
\end{verbatim}
The \texttt{what} variable controls the sequence of calculations made
by \thermo. For each possible value of \texttt{what}, we discuss briefly the
input variables that you can use to control the output plots.

\thermo\ actually writes on file the data to plot and writes a script to plot
these data. The output postscript files are produced by invoking the 
\texttt{gnuplot} program within the code. Usually any modern Linux 
distribution provides a package to install this code, or has it already 
installed by default. If not, you can download it from 
\texttt{http://www.gnuplot.info/}. Three input variables of \thermo\ control 
the use of the \texttt{gnuplot} code:

\begin{verbatim}
lgnuplot    : if .TRUE. gnuplot is called from within the program
              and the postscript files are immediately available
              Default: logical .TRUE.
gnuplot_command  : the command used to call gnuplot.
              Default: character(len=*) 'gnuplot'
flgnuplot   : initial part of the name of the files where gnuplot scripts 
              are written.
              Default: character(len=*) 'gnuplot.tmp'
\end{verbatim}
If you are running \thermo\ on a system that has not \texttt{gnuplot}
you can disable the production of the postscript files and use some other
graphical tools to produce the plots from the output data. 


\subsection{\texttt{what='scf'}}
With this option the code computes only the total energy. This is a single
calculation as if running \texttt{pw.x} with the given input.
No other input variable is necessary.
An example of the use of this option can be found in \texttt{example01}. \\
Number of tasks for this option: \texttt{1}.

\subsection{\texttt{what='scf\_ke'}}
With this option the code makes several self-consistent calculations, 
in parallel on several images, varying the kinetic energy cut-off for 
the wavefunctions and for the charge density. 
In the input of \texttt{pw.x} one specifies the minimum values for these two 
cut-offs. These values are then increased in fixed intervals controlled by the 
following variables. The energy is then plotted as a function of the 
wavefunctions kinetic energy cut-off, a different curve for each value of 
the charge density cut-off.

\begin{verbatim}
nke        : number of kinetic energies tested for the wavefunctions cut-off.
             Default: integer 5
deltake    : delta of wavefunctions kinetic energy cut-off in Ry.
             Default: real 10 Ry
nkeden     : number of kinetic energies tested for the charge density
             cut-off.
             Default: integer 1
deltakeden : delta of charge density kinetic energy cut-off in Ry.
             Default: real 100 Ry.
flkeconv   : name of the file where the data with the total energy as a
             function of the kinetic energy is written.
             Default: character(len=*) 'output_keconv.dat'
flpskeconv : name of the postscript file with the plot of the total energy as
             a function of the kinetic energy cut-off.
             Default: character(len=*) 'output_keconv.ps'
\end{verbatim}
An example of the use of this option can be found in \texttt{example10}. \\
Number of tasks for this option: \texttt{nke * nkedens}.

\subsection{\texttt{what='scf\_nk'}}
With this option the code makes several self-consistent calculations, 
in parallel on several images, varying the size of the {\bf k}-point grid, 
and optionally for metals the smearing parameter \texttt{degauss}. In the 
input of \texttt{pw.x} the minimum value of these parameters is given and 
these values are increased in fixed intervals controlled by the following 
variables. On output the energy is plotted as a function of the mesh size, 
one curve for each smearing parameter.

\begin{verbatim}
nnk        : the number of different values of nk to test
             Default: integer 5
deltank    : the interval between nk values.
             Default: integer 2
nsigma     : the number of smearing intervals.
             Default: integer 1 
deltasigma : the distance between different smearing values.
             Default: 0.005 Ry
flnkconv   : file where the data with the k point convergence is written
             Default: character(len=*) 'output_nkconv.dat'
flpsnkconv : name of the postscript file with the k points convergence plot.
             Default: character(len=*) 'output_nkconv.ps'
\end{verbatim}
An example of the use of this option can be found in \texttt{example11}. \\
Number of tasks for this option: \texttt{nnk * nsigma}.

\subsection{\texttt{what='scf\_bands'}}
With this option the code makes a self-consistent calculation followed 
by a band structure calculation. There is no image parallelization and no
advantage to use more than one image. The output of the band structure 
calculation is further processed in order to produce a plot of the band 
structure.
In insulators the zero of the bands is at the highest valence band in the
first {\bf k} point, in metals at the Fermi energy. 
A minimal control of the plot can be obtained with the following variables.

\begin{verbatim}
emin_input : minimum energy for the band dispersion plot.
             Default: real minimum of the bands
emax_input : maximum energy for the band dispersion plot.
             Default: real maximum of the bands
nbnd_bands : the number of bands in the band calculation
             Default: integer nbnd given in pw.x input.
lsym       : if .TRUE. does the symmetry analysis of the bands
             Default: .TRUE.
flpsband   : postscript file of the electronic band structure
             Default: character(len=*) 'output_band.ps'
\end{verbatim}
Number of tasks for this option: \texttt{1}.

The path for the bands is determined automatically by the code on the basis
of the Bravais lattice index, but it can also be given at the end of
the \texttt{THERMO\_PW} namelist with the same format as in the \texttt{pw.x}
input. In the input of \texttt{pw.x} the {\bf k} points are those of the
self-consistent calculation. The following variables control how the path
is given:
\begin{verbatim}
q_in_band_form   : only the first and last point of each k path are given.
                 The weight of each k point is an integer, the number of 
                 point in the line that start at this k point.
                 Default: .TRUE.
q_in_cryst_coord : the k - points are given in crystal coordinates.
                 Default: .FALSE.
point_label_type : the label definition (see the BZ manual)
                 Default: SC
\end{verbatim}
An example of the use of this option can be found in \texttt{example02}.
If you give explicitly the path, be careful with options that require
geometry changes (see below). Only automatic paths, or path given through 
letter labels are easily recalculated. The other paths could turn out 
to be correct only for one geometry.

\subsection{\texttt{what='plot\_bz'}}
With this option the code writes a script to make a three dimensional plot
of the Brillouin zone and of the path (the default one or the one given in 
input). 
The script must be read by the \texttt{asymptote} code, available at 
\texttt{http://asymptote.sourceforge.net/}. In many Linux distributions
this code is available as a separate package, but it is not installed by
default. The following variables control the plot:
\begin{verbatim}
lasymptote  : if .TRUE. asymptote is called from within the program
              and the pdf file with a plot of the BZ is produced
              Default: logical .FALSE.
flasy       : initial part of the name of the file where the asymptote script
              is written and of the name of the pdf file.
              Default: character(len=*) 'asy_tmp'
asymptote_command  : the command that invokes asymptote and produces the 
              pdf file of the BZ.
              Default: character(len=*) 'asy -f pdf -noprc flasy.asy'
npx         : maximum size of the supercell used to plot the Brillouin
              zone. Used only in the monoclinic case. If the code stops asking
              to double it increase the default until the error disappears.
              Default: integer 8
\end{verbatim}
The structure of the solid can be seen using the \texttt{XCrySDen} code
that can read the input file of \texttt{pw.x}. You can find the code at
\texttt{http://www.xcrysden.org/}. \thermo\ produces also a file in the
\texttt{xsf} format called \texttt{prefix.xsf}, where the variable 
\texttt{prefix}
is given in the input of \texttt{pw.x}. This can be useful when
the inequivalent atomic positions and the space group are given in the input
of \texttt{pw.x}. To see an \texttt{xsf} file, give the command
\texttt{xcrysden --xsf file.xsf}.

\subsection{\texttt{what='scf\_ph'}}
With this option the code makes a phonon calculation at a single {\bf q} 
point or on a mesh of {\bf q} points, as specified in the input of 
the \texttt{ph.x} code after a self-consistent \texttt{pw.x} calculation. 
The different representations are calculated in parallel when several images 
are available. No other input variable is necessary. The outputs of this 
calculation are the dynamical matrices files.
An example of the use of this option can be found in \texttt{example03}. \\
Number of tasks for this option: number of parallelizable tasks of the 
phonon code (smaller but of the order of number of ${\bf q}$ points times 
$3 N_{at}$, where $N_{at}$ is the number of atoms in the unit cell).

\subsection{\texttt{what='scf\_disp'}}
With this option the code makes a phonon dispersion calculation after the 
self-consistent run at a fixed geometry. The geometry is given in the 
input of \texttt{pw.x}. The dynamical matrices are used to calculate 
the interatomic force constants and to interpolate the phonon dispersions 
along a path in the Brillouin zone. The path can be generated automatically 
on the basis of the Bravais lattice index or given in input as in a band 
structure calculation (see above \texttt{what='scf\_bands'}). The code then 
interpolates the phonon on a uniform mesh of {\bf q} points and computes the 
density of vibrational states with a smearing approach. The density of 
states is used to calculate the harmonic thermodynamical properties: 
vibrational energy, vibrational free energy, vibrational entropy, and 
isochoric heat capacity.
The plotted numerical values are per moles in an Avogadro number of unit 
cells. The same thermodynamical quantities are calculated also by direct 
integration over the Brillouin zone and compared in the plots.
The input variables that control this option are:
\begin{verbatim}
freqmin_input : minimum frequency for phonon dos plot.
                Default: real determined from phonon frequencies
freqmax_input : maximum frequency for phonon dos plot.
                Default: real determined from phonon frequencies
deltafreq     : frequency interval for phonon dos plot.
                Default: real 1 cm^{-1}
ndos          : number of frequency points in the dos plot.
                Default: determined from previous data
nq1_d, nq2_d, nq3_d : thick mesh for phonon dos calculation.
                Default: integer 128, 128, 128
zasr          : type of acoustic sum rule applied to the ifc.
                Default: character(len=*) 'Simple'
tmin          : minimum temperature.
                Default: real 1 K
tmax          : maximum temperature.
                Default: real 800 K
deltat        : interval between two temperatures. Be careful with this value
                because too small or too large values of this parameter could 
                give numerical errors in the temperature derivative used to 
                calculate anharmonic properties.
                Default: real 3 K
ntemp         : number of temperatures
                Default: integer determined from previous data

flfrc         : file where the interatomic force constants are written
                Default: character(len=*) 'output_frc.dat.g1'
flfrq         : file where matdyn writes the interpolated frequencies
                Default: character(len=*) 'output_frq.dat.g1'
fldos         : file where the phonon dos is written
                Default: character(len=*) 'output_dos.dat.g1'
fltherm       : file where the harmonic thermodynamic quantities are written
                Default: character(len=*) 'output_therm.dat.g1'
flpsdisp      : postscript file of the phonon dispersions
                Default: character(len=*) 'output_disp.ps'
flpsdos       : postscript file of the phonon dos
                Default: character(len=*) 'output_dos.ps'
flpstherm     : postscript file of the harmonic thermodynamic quantities
                Default: character(len=*) 'output_therm.ps'
\end{verbatim}
An example of the use of this option can be found in \texttt{example04}. \\
Number of tasks for this option: number of parallelizable tasks of the 
phonon code (smaller but of the order of number of ${\bf q}$ points times 
$3 N_{at}$, where $N_{at}$ is the number of atoms in the unit cell).

\subsection{\texttt{what='mur\_lc'}}
With this option the code runs several self-consistent calculations
at different volumes. The runs can be done in parallel when several images 
are available. The total energy as a function of the volume is then 
interpolated with a Murnaghan equation and a plot of the energy
as a function of the volume and of the pressure as a function of the volume is
produced. Presently the volume is changed only by changing \texttt{celldm(1)},
all the other ratios and angles remain fixed at the values given in
the input of \texttt{pw.x}. 
This option can be controlled by the following variables:
\begin{verbatim}
ngeo       : the number of geometries to use.
             The lattice constant of these geometries is calculated from the
             input of pw.x. celldm(1) of this input is used for the central
             geometry. For the others celldm(1) is changed in steps of 
             step_ngeo. ngeo must be odd.
             Default: integer 1 for what=scf_*, 9 for what=mur_lc_*.
step_ngeo  : The step between the lattice constant at different geometries.
             Default: real 0.05 a.u.
ntry       : When the equilibrium lattice constant differs from the lattice 
             constant of the central geometry more than step_ngeo, the code 
             recalculates the Murnaghan equation centering the geometries on 
             the new minimum. This procedure is repeated up to ntry times.
             Default: integer 3
vmin_input : minimum volume for the plot of the energy as a function of volume.
             Default: real 0.98 times the volume of the first geometry.
vmax_input : maximum volume for the plot of the energy as a function of volume.
             Default: real 1.02 times the volume of the last geometry.
deltav     : distance between two volumes in the plot of the energy as a 
             function of the volume.
             Default: real calculated from nvol.
nvol       : number of volumes in Murnaghan plot
             Default : integer 51
flevdat    : file where the Murnaghan equation is written. The results of the
             Murnaghan fit are then written in flevdat.ev.out.
             Default: character(len=*) 'output_ev.dat'
flpsmur    : postscript file of the Murnaghan plot
             Default: character(len=*) 'output_mur.ps'
\end{verbatim}
An example of the use of this option can be found in \texttt{example05}.\\
Number of tasks for this option: \texttt{ngeo}.

\subsection{\texttt{what='mur\_lc\_bands'}}
With this option the code computes the band structure at the geometry 
obtained from the minimum of the Murnaghan equation. See the options 
\texttt{what='scf\_bands'} and \texttt{what='mur\_lc'} for a list of 
the variables that control these two options. An example of the use of 
this option can be found in \texttt{example06}. \\
Number of tasks for this option: \texttt{ngeo}.

\subsection{\texttt{what='mur\_lc\_ph'}}
This option is similar to \texttt{what='scf\_ph'} but the phonon calculation
is made at the geometry obtained from the minimum of the Murnaghan equation.
See the options \texttt{what='scf\_ph'} and \texttt{what='mur\_lc'} for a
list of the variables that control these two options. 
An example of the use of this option can be found in \texttt{example07}. \\
Number of tasks for this option: Maximum between \texttt{ngeo} and the number
of tasks of the phonon code (see above the option \texttt{what='scf\_ph'}).

\subsection{\texttt{what='mur\_lc\_disp'}}
This option is similar to \texttt{what='scf\_disp'} but the phonon calculation
is made at the geometry obtained from the minimum of the Murnaghan equation.
See the options \texttt{what='scf\_disp'} and \texttt{what='mur\_lc'} for a
list of the variables that control these two options. 
An example of the use of this option can be found in \texttt{example08}. \\
Number of tasks for this option: Maximum between \texttt{ngeo} and the number
of tasks of the phonon code (see above the option \texttt{what='scf\_ph'}).

\subsection{\texttt{what='mur\_lc\_t'}}
With this option the code calculates the anharmonic vibrational
properties of the system within the quasi-harmonic approximation. The
outputs of the code are the lattice constant, bulk modulus, and pressure
derivative of the bulk modulus as a function of temperature. Moreover
the isobaric specific heat, the isoentropic bulk modulus, and the average 
Gruneisen parameter are calculated as a function of temperature. Separate
plots of the phonon dispersion along a path specified as described above,
are obtained for all the geometries used in this calculation. For each
geometry the code produces also a plot of the phonon density of states
and of the harmonic thermodynamical quantities. Finally the Gruneisen
parameters interpolated from the three central geometries are
shown on the same path used for the phonon dispersions. The input variables
that control these plot are those described in the option
\texttt{what='mur\_lc'} and \texttt{what='mur\_disp'} in addition to the 
following:

\begin{verbatim}
grunmin_input : minimum y coordinate for the Gruneisen parameter plot.
                Default: real, calculated from the Gruneisen parameters.
grunmax_input : maximum y coordinate for the Gruneisen parameter plot.
                Default: real, calculated from the Gruneisen parameters.
flpgrun       : file where the values of the Gruneisen parameters are written. 
                Default: character(len=*) 'output_pgrun.dat'
flgrun        : file where the Gruneisen parameters in a plotable form are
                written.
                Default: character(len=*) 'output_grun.dat'
flanhar       : file where the anharmonic thermodynamic quantities are written.
                Default: character(len=*) 'output_anhar.dat'
flpsanhar     : postscript file of the anharmonic quantities.
                Default: character(len=*) 'output_anhar.ps'
\end{verbatim}
The output file corresponding to different geometries can be identified
by the presence of the letters \texttt{g1}, \texttt{g2}, ... in the filename.
An example of the use of this option can be found in \texttt{example09}. \\
Number of tasks for this option: Maximum between \texttt{ngeo} and the number
of tasks of the phonon code (see above the option \texttt{what='scf\_ph'}). \\
This option is implemented only for isotropic solids.

\subsection{\texttt{what='elastic\_constants'}}
With this option the code calculates the elastic constants of the solid.
Depending on the Laue class, it calculates the stress tensor for a set of 
strains. For each strain, it relaxes the ions to their 
equilibrium positions if \texttt{frozen\_ions=.false.} or keep them
in the strained positions if \texttt{frozen\_ions=.true.}. 
Finally it computes the elastic constants from the numerical derivatives 
of the stress with respect to strain.
The number of strains used to calculate each derivative 
is \texttt{ngeo\_strain}. The input variables that control this option are:
\begin{verbatim}
frozen_ions: if .true. the elastic constants are calculated 
             keeping the ions frozen in the strained positions. 
             Default: logical .false.
ngeo_strain: the number of strained configurations used to calculate each
             derivative. 
             Default: integer 4
delta_epsilon: the interval of strain values between two geometries.
               To avoid a zero strain geometry that might have a
               different symmetry ngeo_strain must be even.
               Default: real 0.002
fl_el_cons: the name of the file that contains the elastic constants
            Default: character(len=*) 'output_el_con.dat'

\end{verbatim}
Number of tasks for this option: \texttt{ngeo\_strain} times the number of
required independent strains.

\subsection{\texttt{what='mur\_lc\_elastic\_constants'}}
As \texttt{what='elastic\_constants'} but the calculation is made at the
geometry that corresponds to the minimum of the Murnaghan equation. The
Murnaghan minimization is made as described for \texttt{what='mur\_lc'}.
An example of the use of this option can be found in \texttt{example13}. \\
Number of tasks for this option: maximum between \texttt{ngeo} and
\texttt{ngeo\_strain} times the number of required independent strains.

\subsection{\texttt{what='piezoelectric\_tensor'}}
With this option the code calculates the piezoelectric tensor 
($g_{\alpha,m}$ $\alpha=1,3,\ m=1,6$) of the solid.
Depending on the point group, it calculates the polarization of the
solid for a set of strains of the lattice. For each strain, it relaxes 
the ions to their equilibrium positions when \texttt{frozen\_ions=.false.} 
or keep them in the strained positions when \texttt{frozen\_ions=.true.}. 
Finally it computes the piezoelectric tensor from the numerical derivatives 
of the polarization with respect to strain.
The number of strains used to compute each derivative is \texttt{ngeo\_strain}. The input variables
that control this option are the same as those used for the elastic constant:
\begin{verbatim}
frozen_ions: if .true. the piezoelectric tensor is calculated 
             keeping the ions frozen in the strained positions. 
             Default: logical .false.
ngeo_strain: the number of strained configurations used. 
             Default: integer 4
nppl:        the number of k-points per line in Berry phase calculations
             Default: integer 51
delta_epsilon: the interval of strain values between two geometries.
               To avoid a zero strain geometry that might have a
               different symmetry ngeo_strain must be even.
               Default: real 0.002
\end{verbatim}
If a file with the elastic constants is found on disk, the code computes also
the direct piezoelectric tensor $d_{\alpha,m}$ which describes
the polarization induced by an external stress, as $d_{\alpha,m}=
\sum_n g_{\alpha,n} C_{nm}^{-1}$. All these quantities are calculated 
for a vanishing electric field. \\
This feature is still uncomplete and experimental.

\subsection{\texttt{what='mur\_lc\_piezoelectric\_tensor'}}
As \texttt{what='piezoelectric\_tensor'} but the calculation is made at the
geometry that corresponds to the minimum of the Murnaghan equation. The
Murnaghan minimization is made as described for \texttt{what='mur\_lc'}. \\
This feature is still uncomplete and experimental.

\subsection{\texttt{what='polarization'}}
With this option the code calculates the spontaneous polarization.
The code makes a self-consistent calculation followed by three Berry
phase calculations in which the polarization is calculated in the
direction parallel to the three primitive reciprocal lattice vectors and 
prints the spontaneous polarization in cartesian coordinates.
The input variable that control this option is:
\begin{verbatim}
nppl: the number of k points per string. In the perpendicular plane the
      number of k-point is that given as input of the pw.x code.
      Default: integer 51
\end{verbatim}
This feature is still uncomplete and experimental.

\subsection{\texttt{what='mur\_lc\_polarization'}}
As \texttt{what='polarization'} but the calculation is made at the
geometry that corresponds to the minimum of the Murnaghan equation. The
Murnaghan minimization is made as described for \texttt{what='mur\_lc'}.\\
This feature is still uncomplete and experimental.

\subsection{\texttt{what='scf\_2d\_bands'}}
With this option the code calculates the bands after a self consistent 
calculation as with the option \texttt{what='scf\_bands'}, but it assumes 
that the cell contains a slab with surfaces perpendicular to the $z$ 
direction. Therefore the two-dimensional Bravais lattice of the surface 
is identified and the default path is chosen on the two-dimensional 
Brillouin zone. 
There are three options: Plot of the projected band structure (PBS); 
plot of the bands of the slab; plot of the bands of the slab above the
projected band structure (the Fermi energies are aligned). In the first 
case the code computes several paths
of ${\bf k}$-points parallel to the surface (at different $k_z$) and does 
not plot the individual bands but selects the energy regions in which 
there are bulk states. The second case is similar to a standard band plot. 
The default path contains only ${\bf k}$-points parallel to the 
surface (with $k_z=0$). The third case assumes that the projected band 
structure has been already calculated and the information to plot it 
can be found on the file \texttt{flpbs}. For the rest it is 
similar to case two. For each direction, bands belonging to different 
irreducible representations of the small group ${\bf k}$ can be plotted 
in the same panel or on different panels.
This option is controlled by the following variables:
\begin{verbatim}
lprojpbs : When .TRUE. the projected band structure (PBS) is calculated 
     if nkz > 1 otherwise it is read from file. Usually this variable is
     .TRUE.. Set it to .FALSE. if you do not want to see the PBS, 
     or if you want to see the bands of a bulk projected on the 
     surface Brillouin zone without the PBS.
     Default: logical .TRUE. (forced to .FALSE. if what is not 'scf_2d_bands')
nkz  : The number of k_z values used for the PBS plot. 
     If lprojpbs is .FALSE. a plot of the bulk bands projected on the 
     surface Brillouin zone is produced.
     (forced to 1 if what is not 'scf_2d_bands').
     Default: integer 4
gap_thr : minimum size (in eV) of the gaps in the PBS
     Default: double precision 0.1
sym_divide: When .TRUE. the bands belonging to different irreducible 
     representations are plotted in different panels. This option
     can be controlled by variables specified in the path (see below)
     Default : logical .FALSE.
identify_sur: When .TRUE. the surface bands are searched and identified on the
     surface band structure. 
     Default : logical .FALSE.
dump_states: If .TRUE. and identify_sur is .TRUE. dump on the file 
     'dump/state_k_#' the planar averages of the density (and in the 
     noncollinear case also of the magnetization density) of each state. 
     One file for each k point is produced and # is the number of the k points.
     (Use with a small number of k points or it might create quite large files).
     Default: logical .FALSE.
sur_layers: The number of surface layers on which we add the charge density of 
     each state to check if it is a surface state.
     Default : integer 2
sur_thr : the threshold (in percentage) of the charge density that must be
     on the surface layers to identify a state as a surface state.
     Default: calculated from the actual charge density values of the states.
subtract_vacuum: if .TRUE. the charge density of each state on vacuum is
     subtracted (to remove the vacuum states that are confused with surface
     states)
     Default : .TRUE.
force_bands: when .TRUE. the bands are plotted in any case.
     Used to plot the bulk bands on top of the PBS, mainly for debugging.
     Default: logical .FALSE.
only_bands_plot: if the files with the bands, the representations, the pbs
     and the projections are already on files, this option allows to change
     the parameters of the plot (such as the maximum energy or sur_thr) and
     do another plot without any additional calculation. If the files are
     missing and this variable is .TRUE. an error occurs.
     Default: logical .FALSE.
flpbs : the name of the file that contains the information on the projected
     band structure.
     Default: character(len=*) 'output_pbs'
flprojlayer : the name of the file that contains the information of the
     projection of the charge density of each state on each layer.
     Calculated only when identify_sur is .TRUE..
     Default: character(len=*) 'output_projlayer'
\end{verbatim}
The bands and the gnuplot scripts are saved on the same files that would
be used with the option \texttt{what='scf\_bands'}. \\
Number of tasks for this option: \texttt{1}. Image parallelization is
not useful with this option. 

By default the symmetry separation is not carried out. The code plots the
bands of the slab on the same panel with a different color for each 
representation as in the bulk band structure plot (color refer to the 
representations of the slab small group of {\bf k}). 
In order to plot in different panels the different representations
the user can specify \texttt{sym\_divide=} \texttt{.TRUE.}.
By default this option is disabled and its use is rather tricky.
In order to use this option you must indicate explicitly the
path on the two dimensional Brillouin zone using the option
\texttt{q\_in\_band\_form=.TRUE.}. Close to the
starting point of a given line you must indicate the number of 
representations for that line ($0$ means all representations) and which ones.
For instance for a $(111)$ surface of an fcc metal you may
want to plot separately the even and odd states in the direction 
$\bar \Gamma-\bar M$. In order to do so you can specify the path as follows:
\begin{verbatim}
5
gG   30  0
K    30  0
M    30  1  1
gG   30  1  2
M     1  0
\end{verbatim}
Which representation is indicated by its number (in this case $1$ or $2$).
The number of the representation and the small point group of each 
${\bf k}$-point can be found in the output of \texttt{thermo\_pw}.
However you must be careful because these representation numbers refer
to the slab small point group of each ${\bf k}$-point when you
plot the slab band structures and to the surface small point 
group of each ${\bf k}$-point when you plot a PBS.
For a given ${\bf k}$-point parallel to the surface, the slab
might have a point group larger than the true surface, because it 
might contain operations that exchange the two surfaces.
In this case the surface point group of a given ${\bf k}$-point parallel 
to the surface can be found in the projected band structure calculation,
for a ${\bf k}$-point with the same component parallel to the surface
and a generic $k_z$. Actually the point group for this ${\bf k}$-point 
does not contain operations that exchange $k_z$ with $-k_z$.
Therefore the symmetry separation of the PBS is done using the
surface point groups. Some particular values of $k_z$, such as $k_z=0$
might have a different point group than a generic $k_z$ and in this
case the representations are transformed into those of the smaller
group of the surface using the group-subgroup relationships and
the descent in symmetry of the irreducible representations
(only when \texttt{sym\_divide=.TRUE.}).
It is the user responsibility to specify the same number of panels
for the PBS and for the slab calculation and to assure that the
representations plotted in each panel correspond to each other.
Returning to the example of the $(111)$ surface of an fcc, in the direction
$\bar \Gamma-\bar K$ the slab has $C_2$ symmetry about the $x$-axis, a symmetry
that the surface has not. Therefore you can plot with two different colors
the bands that belong to the $A$ or $B$ representations of the slab,
(states even or odd with respect to and $180^\circ$  rotation about
the $x$ axis, an operation that exchanges the two surfaces)
but you cannot separate the PBS along the $\bar \Gamma-\bar K$ direction into
even or odd. You might specify two different panels with the
$A$ or $B$ bands in each, but the PBS in the two panels will be the same. 
On the contrary, along the $\bar \Gamma-\bar M$ direction, both the slab and 
the surface have $C_s$ symmetry, so you can separate both the PBS 
and the surface states in two different panels.

There is no input variable to control or change the colors or style of the 
plot. To change the defaults you can modify directly the gnuplot script,
it is written in such a way that a change to a few variables can
control the entire plot.

\section{Tools}

The directory tools contains a few tools that can be useful to build
structures of solids, surfaces, ribbons, and nanowires. Currently it contains
the following programs:

\begin{itemize}

\item \texttt{group\_name.x} a small tool that gives the names of the 
space group that correspond to a given space group number. 

\item \texttt{group\_number.x} a small tool that gives the space group number
that corresponds to a given space group name. It also lists many equivalent
names of the same group.

\item \texttt{gener\_nanowire.x} a small tool that reads a two dimensional (2D)
Bravais lattice index and atomic coordinates an generates a sheet of type
$(m,n)$. A sheet contained between the two vectors 
${\bf C} = m {\bf a}_1 + n {\bf a}_2$ and ${\bf T} = p {\bf a}_1 + q {\bf a}_2$
can be also generated and wrapped about ${\bf C}$ in a nanotube form 
(${\bf a}_1$ and ${\bf a}_2$ are the primitive lattices of the 2D Bravais 
lattice). 
For lattices that allow it, $p$ and $q$ can be determined automatically so that 
${\bf T}$ is perpendicular to ${\bf C}$.

\item \texttt{gener\_2d\_slab.x} a small tool that reads a two dimensional 
Bravais lattice index and atomic coordinates an generates an infinite ribbon
perpendicular to ${\bf G} = m {\bf b}_1 + n {\bf b}_2$, where 
${\bf b}_1$ and ${\bf b}_2$ are the primitive Bravais lattice vectors 
of the 2D Bravais lattice. The number of rows of the ribbon, and the number of
atoms per row are given as an input variables.

\end{itemize}

For a detailed description of each input variables please look at the beginning 
of the \texttt{fortran} sources of each code.

\end{document}
